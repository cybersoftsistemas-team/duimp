name: Build

on:
  # Gatilho para todas as atividades relevantes de pull request em main e develop
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened, closed]

# Define o shell padrÃ£o para todos os jobs neste workflow.
defaults:
  run:
    shell: bash

jobs:
  # --------------------------------------------------------------------
  # JOB DE DEBUG: Executa sempre para mostrar o contexto do evento.
  # --------------------------------------------------------------------
  debug-context:
    name: "ğŸ” Debug do Contexto do Evento"
    runs-on: self-hosted
    steps:
      - name: "Imprime o contexto 'github' completo em formato JSON"
        # Este comando agora serÃ¡ executado com bash, evitando erros de PowerShell.
        run: echo "${{ toJSON(github) }}"

  # --------------------------------------------------------------------
  # 1) ValidaÃ§Ã£o de PR (enquanto o PR de 'develop' para 'main' estÃ¡ aberto)
  # --------------------------------------------------------------------
  validate-main-pr:
    name: "ğŸš¨ ValidaÃ§Ã£o de PR (develop â†’ main)"
    runs-on: self-hosted
    # Este job sÃ³ executa em PRs ABERTOS que tÃªm 'main' como destino.
    if: >
      github.event.action != 'closed' &&
      github.event.pull_request.base.ref == 'main'
    steps:
      - name: "Verifica se a origem do PR Ã© 'develop'"
        # A sintaxe 'if' abaixo agora funcionarÃ¡ corretamente com bash.
        run: |
          echo "Base (destino) do PR: ${{ github.event.pull_request.base.ref }}"
          echo "Head (origem) do PR: ${{ github.event.pull_request.head.ref }}"
          if [ "${{ github.event.pull_request.head.ref }}" != "develop" ]; then
            echo "::error ::PR invÃ¡lido! Pull requests para 'main' devem vir exclusivamente da branch 'develop'."
            exit 1
          else
            echo "âœ… ValidaÃ§Ã£o de PR bem-sucedida."
          fi

  # ---------------------------------------------------------------
  # 2) Build HomologaÃ§Ã£o (executa apÃ³s merge para 'develop')
  # ---------------------------------------------------------------
  build-homologation:
    name: "ğŸ› ï¸ Build HomologaÃ§Ã£o"
    runs-on: self-hosted
    # Este job sÃ³ executa quando um PR Ã© MERGADO na branch 'develop'.
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'develop'
    steps:
      - name: "Checkout da branch 'develop'"
        uses: actions/checkout@v4
      - name: "Publicando build de homologaÃ§Ã£o"
        run: echo "ğŸš€ Build de HomologaÃ§Ã£o rodando apÃ³s merge para 'develop'."

  # --------------------------------------------------------------------
  # 3) Build ProduÃ§Ã£o (executa apÃ³s merge de 'develop' para 'main')
  # --------------------------------------------------------------------
  build-production:
    name: "ğŸš€ Build ProduÃ§Ã£o"
    runs-on: self-hosted
    needs: validate-main-pr # Garante que a validaÃ§Ã£o seja considerada
    # Este job sÃ³ executa quando um PR de 'develop' Ã© MERGADO na branch 'main'.
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'develop'
    steps:
      - name: "Checkout da branch 'main'"
        uses: actions/checkout@v4
      - name: "Publicando build de produÃ§Ã£o"
        run: echo "ğŸš€ Build de ProduÃ§Ã£o rodando apÃ³s merge de 'develop' para 'main'."